<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #282c34;
      color: #e0e6f1;
      padding: 20px;
      direction: rtl; /* Ù„Ø¶Ù…Ø§Ù† Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    h1 {
        color: #61dafb;
        text-align: center;
        margin-bottom: 25px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    #chatbox {
      flex-grow: 1;
      width: 100%;
      max-height: calc(100vh - 200px); /* Ø­Ø¬Ù… ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
      overflow-y: auto; /* Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù…ØªÙ„Ø§Ø¡ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
      border: 1px solid #4a4f59;
      padding: 15px;
      margin-bottom: 15px;
      background: #3a3f4a;
      direction: rtl; /* Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± */
      text-align: right; /* Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ Ù„Ù„ÙŠÙ…ÙŠÙ† */
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column-reverse; /* Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
    }
    #chatbox p {
        margin: 8px 0;
        line-height: 1.5;
        padding: 5px 10px;
        border-radius: 5px;
        max-width: 85%;
        word-wrap: break-word; /* Ù„ÙƒØ³Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
    }
    #chatbox p strong {
        font-weight: bold;
    }
    #chatbox p strong:contains("Ø£Ù†Øª") { /* Ù„ÙˆÙ† Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        color: #98fb98;
    }
    #chatbox p strong:contains("Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ") { /* Ù„ÙˆÙ† Ù„Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª */
        color: #88B04B;
    }
    #chatbox p:has(strong:contains("Ø£Ù†Øª")) { /* Ø®Ù„ÙÙŠØ© Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        background-color: #555c6e;
        align-self: flex-end; /* Ù„ØªØ¹ÙˆÙŠÙ… Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙŠÙ…ÙŠÙ† */
        border-bottom-left-radius: 0;
    }
    #chatbox p:has(strong:contains("Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ")) { /* Ø®Ù„ÙÙŠØ© Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª */
        background-color: #4a4f59;
        align-self: flex-start; /* Ù„ØªØ¹ÙˆÙŠÙ… Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª Ù„Ù„ÙŠØ³Ø§Ø± */
        border-bottom-right-radius: 0;
    }

    .input-controls {
        display: flex;
        align-items: center;
        justify-content: flex-end; /* Ù…Ø­Ø§Ø°Ø§Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„ÙŠÙ…ÙŠÙ† */
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    input[type="text"] {
      flex-grow: 1;
      max-width: calc(100% - 250px); /* Ø¹Ø±Ø¶ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
      padding: 12px;
      border: 1px solid #5a5f6a;
      border-radius: 5px;
      background-color: #4a4f59;
      color: #e0e6f1;
      direction: rtl; /* Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± */
      text-align: right; /* Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ Ù„Ù„ÙŠÙ…ÙŠÙ† */
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus {
        border-color: #61dafb;
    }
    button {
      padding: 12px 20px;
      cursor: pointer;
      background-color: #61dafb;
      color: #282c34;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background-color: #21a1f1;
      transform: translateY(-2px);
    }

    /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù€ Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
        input[type="text"] {
            max-width: 100%;
            margin-bottom: 10px;
        }
        .input-controls {
            flex-direction: column;
            align-items: stretch;
        }
        button {
            width: 100%;
        }
    }
  </style>
</head>
<body>
  <h1>ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1>
  <div id="chatbox"></div>
  <div class="input-controls">
    <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
    <button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
    <button onclick="startVoiceInput()">ğŸ¤ Ø§Ù„ØªØ­Ø¯Ø«</button>
    <button onclick="stopVoiceInput()" id="stopVoiceBtn" style="display:none;">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯Ø«</button>
    <button onclick="clearChat()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
  </div>

  <script>
    const chatbox = document.getElementById("chatbox");
    let currentContext = null; // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹Ù‡)
    let userName = localStorage.getItem("assistantUserName"); // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠÙ‹Ø§

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    function appendMessage(senderName, textContent) {
      const messageElement = document.createElement('p');
      messageElement.innerHTML = `<strong>${senderName}:</strong> ${textContent}`;
      chatbox.prepend(messageElement); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
      chatbox.scrollTop = chatbox.scrollHeight; // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„ (Ù„Ù† ÙŠØ¹Ù…Ù„ Ù…Ø¹ prepend)
      // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… appendChildØŒ ÙØ³ÙŠØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.
      // Ù…Ø¹ prependØŒ Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹.

      if (senderName === "ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ") {
          speakResponse(textContent); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    function clearChat() {
      chatbox.innerHTML = '';
      currentContext = null;
      appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„Ø¢Ù†ØŸ");
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function setUserName(name) {
      userName = name;
      localStorage.setItem("assistantUserName", name);
    }

    // --- Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… ---
    async function send() {
      const inputField = document.getElementById("userInput");
      const message = inputField.value.trim();
      if (!message) return; // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ù‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©

      appendMessage("ğŸ§‘â€ğŸ’» Ø£Ù†Øª", message); // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
      inputField.value = ""; // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„

      try {
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ POST Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ
        const response = await fetch('http://localhost:3000/ask-ai', { // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„ØµØ­ÙŠØ­
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ query: message }) // Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ€ JSON
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        if (!response.ok) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (Ù…Ø«Ù„ 404ØŒ 500)ØŒ Ø£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù…ÙŠ (${response.status} ${response.statusText}). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„Ù‡.`);
            console.error("Server error:", response.status, response.statusText);
            return;
        }

        const data = await response.json(); // ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù… ÙƒÙ€ JSON
        const aiResponse = data.response; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ

        if (aiResponse) {
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", aiResponse); // Ø¹Ø±Ø¶ Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        } else {
            console.error("AI service returned an empty or null response.");
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ„Ù‚ Ø±Ø¯Ø§Ù‹ ØµØ§Ù„Ø­Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯.`);
        }
      } catch (error) {
        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ© (Ù…Ø«Ù„ Ø¹Ø¯Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…)
        console.error("Error communicating with backend server:", error);
        appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù…ÙŠ Ø§Ù„Ø¢Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„Ù‡ (node server.js).`);
      }
    }

    // --- Speech Recognition (Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØµÙˆØªÙŠ) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;
    const stopVoiceBtn = document.getElementById("stopVoiceBtn");

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'ar-EG'; // Ù„ØºØ© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù… (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©)
        recognition.interimResults = false; // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        recognition.maxAlternatives = 1; // Ø£ÙØ¶Ù„ Ø¨Ø¯ÙŠÙ„ ÙˆØ§Ø­Ø¯

        recognition.onstart = () => {
            isListening = true;
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "Ø£Ø³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†... Ù‚Ù„ Ø´ÙŠØ¦Ø§Ù‹.");
            stopVoiceBtn.style.display = 'inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
        };

        recognition.onresult = (event) => {
            const speechResult = event.results[0][0].transcript;
            document.getElementById("userInput").value = speechResult; // ÙˆØ¶Ø¹ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¹ØªØ±Ù Ø¨Ù‡ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            send(); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¹ØªØ±Ù Ø¨Ù‡
            stopVoiceInput(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…
        };

        recognition.onerror = (event) => {
            console.error("Speech Recognition Error:", event.error);
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            isListening = false;
            stopVoiceBtn.style.display = 'none';
        };

        recognition.onend = () => {
            if (isListening) { // Ø¥Ø°Ø§ ØªÙˆÙ‚Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆÙ„Ù… ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡ ÙŠØ¯ÙˆÙŠØ§
                appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "ØªÙˆÙ‚Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹.");
            }
            isListening = false;
            stopVoiceBtn.style.display = 'none';
        };

    } else {
        console.warn("Speech Recognition not supported in this browser.");
        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø¯Ø®Ù„ Ø§Ù„ØµÙˆØªÙŠ Ù…Ø¯Ø¹ÙˆÙ…Ø§Ù‹
        document.querySelector('button[onclick="startVoiceInput()"]').style.display = 'none';
        document.getElementById("stopVoiceBtn").style.display = 'none';
    }

    function startVoiceInput() {
        if (recognition && !isListening) {
            recognition.start();
        } else if (isListening) {
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "Ø£Ù†Ø§ Ø£Ø³ØªÙ…Ø¹ Ø¨Ø§Ù„ÙØ¹Ù„.");
        } else {
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù… ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.");
        }
    }

    function stopVoiceInput() {
        if (recognition && isListening) {
            recognition.stop();
            isListening = false;
        }
    }

    // --- Speech Synthesis (Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØª - Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯) ---
    const SpeechSynthesis = window.speechSynthesis;
    let speakingQueue = []; // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ©
    let isSpeaking = false;

    function speakResponse(textToSpeak) {
        if (!SpeechSynthesis || textToSpeak.trim() === "") {
            return;
        }

        // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ÙƒÙ„Ø§Ù… Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙƒÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯
        if (isSpeaking && speakingQueue.length === 0) {
             SpeechSynthesis.cancel();
        }

        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        utterance.lang = 'ar-EG'; // Ù„ØºØ© Ø§Ù„Ù†Ø·Ù‚ (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©)
        utterance.rate = 0.95; // Ø³Ø±Ø¹Ø© Ø§Ù„Ù†Ø·Ù‚
        utterance.pitch = 1; // Ø­Ø¯Ø© Ø§Ù„ØµÙˆØª

        utterance.onend = () => {
            speakingQueue.shift(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø·ÙˆÙ‚Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            if (speakingQueue.length > 0) {
                SpeechSynthesis.speak(speakingQueue[0]); // Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            } else {
                isSpeaking = false; // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø£Ø®Ø±Ù‰ØŒ ØªÙˆÙ‚Ù Ø§Ù„Ù†Ø·Ù‚
            }
        };

        utterance.onerror = (event) => {
            console.error('SpeechSynthesisUtterance.onerror', event);
            isSpeaking = false;
            speakingQueue = []; // Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
        };

        speakingQueue.push(utterance); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        if (!isSpeaking) {
            isSpeaking = true;
            SpeechSynthesis.speak(speakingQueue[0]); // Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø·Ù‚ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙƒÙ„Ø§Ù… Ø­Ø§Ù„ÙŠ
        }
    }

    // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = () => {
        if (userName) {
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙŠØ§ ${userName}! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ`);
        } else {
            appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ");
        }
        appendMessage("ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "Ù„Ù„Ø¨Ø¯Ø¡ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ ÙÙŠ Ù†Ø§ÙØ°Ø© Terminal/Command Prompt (Ù…Ø«Ø§Ù„: node server.js ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø®Ø§Ø¯Ù…).");
    };
  </script>
</body>
</html>
